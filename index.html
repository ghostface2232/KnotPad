<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KnotPad</title>
    <meta name="theme-color" content="#09090b">
    <meta name="description" content="Infinite canvas for notes, links, and ideas">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KnotPad">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
    <style>
        @font-face { font-family: 'SFKR'; src: url('./fonts/SFKR-Regular.otf') format('opentype'); font-weight: 400; }
        @font-face { font-family: 'SFKR'; src: url('./fonts/SFKR-Medium.otf') format('opentype'); font-weight: 500; }
        @font-face { font-family: 'SFKR'; src: url('./fonts/SFKR-Bold.otf') format('opentype'); font-weight: 700; }

        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-card: #1f1f23;
            --bg-hover: rgba(255, 255, 255, 0.06);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-active: rgba(255, 255, 255, 0.16);
            --text-primary: #fafafa;
            --text-secondary: rgba(255, 255, 255, 0.64);
            --text-placeholder: rgba(255, 255, 255, 0.32);
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.24);
            --accent-dim: rgba(59, 130, 246, 0.4);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.4);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.48);
            --grid-color: rgba(255, 255, 255, 0.03);
            --scrollbar: rgba(255, 255, 255, 0.16);
            --danger: #ef4444;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: 0.15s ease;
            --tag-red: #ef4444; --tag-orange: #f97316; --tag-yellow: #eab308;
            --tag-green: #22c55e; --tag-blue: #3b82f6; --tag-purple: #8b5cf6; --tag-pink: #ec4899;
        }

        :root.light {
            --bg-primary: #f4f4f5; --bg-secondary: #ffffff; --bg-card: #ffffff;
            --bg-hover: rgba(0, 0, 0, 0.04);
            --border-subtle: rgba(0, 0, 0, 0.08); --border-active: rgba(0, 0, 0, 0.16);
            --text-primary: #18181b; --text-secondary: rgba(0, 0, 0, 0.56); --text-placeholder: rgba(0, 0, 0, 0.32);
            --accent: #2563eb; --accent-glow: rgba(37, 99, 235, 0.16); --accent-dim: rgba(37, 99, 235, 0.3);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08); --shadow-lg: 0 16px 48px rgba(0,0,0,0.12);
            --grid-color: rgba(0, 0, 0, 0.04); --scrollbar: rgba(0, 0, 0, 0.16); --danger: #dc2626;
        }

        html, body {
            height: 100%; overflow: hidden;
            font-family: 'SFKR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary); color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
        }
        input, textarea, button { font-family: inherit; }

        #app { width: 100%; height: 100%; position: relative; overflow: hidden; background: var(--bg-primary); outline: none; cursor: default; }
        #app.panning { cursor: grabbing; }

        #canvas { position: absolute; width: 100%; height: 100%; transform-origin: 0 0; }

        .grid-overlay {
            position: absolute; inset: -200%; width: 500%; height: 500%;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px),
                              linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 48px 48px; pointer-events: none;
        }

        #connectionsSvg { position: absolute; inset: -10000px; width: 20000px; height: 20000px; pointer-events: none; overflow: visible; }

        .connection-line { fill: none; stroke: var(--accent-dim); stroke-width: 2; pointer-events: stroke; cursor: pointer; }
        .connection-line:hover { stroke: var(--accent); stroke-width: 3; }
        .connection-line.selected { stroke: var(--accent); stroke-width: 3; }
        .connection-line.temp { stroke-dasharray: 6 4; opacity: 0.6; }

        .connection-arrow { fill: var(--accent-dim); pointer-events: none; }
        .connection-arrow.selected { fill: var(--accent); }

        #selectionBox { position: fixed; border: 1.5px solid var(--accent); background: var(--accent-glow); display: none; pointer-events: none; z-index: 9999; border-radius: 4px; }

        .canvas-item {
            position: absolute; background: var(--bg-card); border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            --tag-shadow: 0 0 0 0 transparent;
            box-shadow: var(--shadow-md), var(--tag-shadow);
            cursor: move; min-width: 140px; min-height: 80px; overflow: visible;
        }
        .canvas-item:hover { border-color: var(--border-active); box-shadow: var(--shadow-lg), var(--tag-shadow); }
        .canvas-item.selected { border-color: var(--accent); box-shadow: var(--shadow-lg), 0 0 0 3px var(--accent-glow), var(--tag-shadow); }
        .canvas-item.dragging { opacity: 0.9; }
        .canvas-item.connect-target { border-color: var(--accent); }
        .canvas-item.filtered-out { opacity: 0.15; pointer-events: none; }
        .canvas-item.locked { opacity: 0.7; }
        .canvas-item.search-highlight { box-shadow: var(--shadow-lg), 0 0 0 4px var(--tag-yellow), var(--tag-shadow); }
        .canvas-item.new { animation: appear 0.2s ease-out; }
        @keyframes appear { from { opacity: 0; transform: scale(0.96); } }

        .item-content { width: 100%; height: 100%; overflow: hidden; border-radius: calc(var(--radius-md) - 1px); }

        .canvas-item .delete-btn, .canvas-item .color-btn {
            position: absolute; top: -10px; width: 24px; height: 24px; border-radius: 50%;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: all var(--transition); font-size: 14px; z-index: 10;
        }
        .canvas-item .delete-btn { right: -10px; }
        .canvas-item .color-btn { right: 18px; }
        .canvas-item:hover .delete-btn, .canvas-item:hover .color-btn { opacity: 1; }
        .canvas-item .delete-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
        .canvas-item .color-btn:hover { background: var(--bg-hover); color: var(--text-primary); }

        .color-picker {
            position: absolute; top: 18px; right: -10px;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); padding: 6px;
            display: none; gap: 4px; flex-wrap: wrap; width: 76px;
            box-shadow: var(--shadow-md); z-index: 100;
        }
        .color-picker.active { display: flex; }
        .color-picker .color-opt { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-picker .color-opt:hover { transform: scale(1.2); }
        .color-picker .color-opt.selected { border-color: var(--text-primary); }
        .color-picker .color-opt.none { background: var(--bg-card); border: 2px dashed var(--border-active); }

        .canvas-item .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 18px; height: 18px;
            cursor: nwse-resize; opacity: 0; z-index: 10;
        }
        .canvas-item:hover .resize-handle { opacity: 0.6; }
        .resize-handle::before {
            content: ''; position: absolute; bottom: 4px; right: 4px;
            width: 10px; height: 10px;
            border-right: 2px solid var(--text-secondary);
            border-bottom: 2px solid var(--text-secondary);
            border-radius: 0 0 3px 0;
        }

        .connection-handle {
            position: absolute; width: 14px; height: 14px;
            background: var(--accent); border: 2px solid var(--bg-card);
            border-radius: 50%; cursor: crosshair; opacity: 0; z-index: 20;
        }
        .canvas-item:hover .connection-handle { opacity: 1; }
        .connection-handle:hover { transform: scale(1.4); }
        .connection-handle.top { top: -7px; left: 50%; margin-left: -7px; }
        .connection-handle.bottom { bottom: -7px; left: 50%; margin-left: -7px; }
        .connection-handle.left { left: -7px; top: 50%; margin-top: -7px; }
        .connection-handle.right { right: -7px; top: 50%; margin-top: -7px; }

        .add-child-btn {
            position: absolute; width: 24px; height: 24px;
            background: var(--accent); border: 2px solid var(--bg-card);
            border-radius: 50%; cursor: pointer; opacity: 0; z-index: 20;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 14px; font-weight: 600;
        }
        .canvas-item:hover .add-child-btn { opacity: 1; }
        .add-child-btn:hover { transform: scale(1.2); }
        .add-child-btn.top { top: -32px; left: 50%; margin-left: -12px; }
        .add-child-btn.bottom { bottom: -32px; left: 50%; margin-left: -12px; }
        .add-child-btn.left { left: -32px; top: 50%; margin-top: -12px; }
        .add-child-btn.right { right: -32px; top: 50%; margin-top: -12px; }

        .child-type-picker {
            position: absolute; background: var(--bg-secondary);
            border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
            padding: 4px; display: none; gap: 4px; box-shadow: var(--shadow-lg); z-index: 200;
        }
        .child-type-picker.active { display: flex; }
        .child-type-picker button {
            padding: 6px 12px; border: none; background: var(--bg-card);
            color: var(--text-primary); border-radius: 4px; cursor: pointer; font-size: 12px;
        }
        .child-type-picker button:hover { background: var(--accent); color: white; }

        .item-image { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; border-radius: calc(var(--radius-md) - 1px); }
        .item-video { width: 100%; height: 100%; object-fit: contain; background: #000; display: block; }

        .item-note { padding: 14px; height: 100%; display: flex; flex-direction: column; gap: 6px; max-height: 400px; }
        .note-title { font-size: 14px; font-weight: 600; color: var(--text-primary); border: none; background: transparent; outline: none; width: 100%; flex-shrink: 0; }
        .note-title::placeholder { color: var(--text-secondary); }
        .note-body { flex: 1; font-size: 13px; line-height: 1.6; color: var(--text-secondary); border: none; background: transparent; outline: none; resize: none; width: 100%; overflow-y: auto; }
        .note-body::placeholder { color: var(--text-placeholder); }
        .note-body::-webkit-scrollbar { width: 4px; }
        .note-body::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 2px; }

        .item-memo { padding: 12px; height: 100%; display: flex; flex-direction: column; max-height: 400px; }
        .memo-body { flex: 1; font-size: 13px; line-height: 1.6; color: var(--text-primary); border: none; background: transparent; outline: none; resize: none; width: 100%; overflow-y: auto; }
        .memo-body::placeholder { color: var(--text-placeholder); }
        .memo-body::-webkit-scrollbar { width: 4px; }
        .memo-body::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 2px; }

        .item-link { padding: 16px; display: flex; flex-direction: column; gap: 10px; height: 100%; }
        .link-favicon { width: 28px; height: 28px; border-radius: 6px; background: var(--bg-hover); }
        .link-title { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .link-url { font-size: 12px; color: var(--text-secondary); text-decoration: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .link-url:hover { color: var(--accent); }

        .drop-overlay {
            position: fixed; inset: 0; background: rgba(9, 9, 11, 0.92);
            display: none; align-items: center; justify-content: center;
            z-index: 9999; backdrop-filter: blur(8px);
        }
        :root.light .drop-overlay { background: rgba(244, 244, 245, 0.92); }
        .drop-overlay.active { display: flex; }
        .drop-content { text-align: center; padding: 48px 64px; border: 2px dashed var(--accent); border-radius: var(--radius-lg); background: var(--accent-glow); }
        .drop-content svg { width: 48px; height: 48px; margin-bottom: 16px; color: var(--accent); }
        .drop-content h3 { font-size: 20px; font-weight: 500; margin-bottom: 4px; }
        .drop-content p { font-size: 13px; color: var(--text-secondary); }

        .toolbar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 4px; padding: 8px;
            background: var(--bg-secondary); border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle); box-shadow: var(--shadow-lg); z-index: 100;
        }
        .toolbar-btn {
            width: 40px; height: 40px; border-radius: var(--radius-sm);
            border: none; background: transparent; color: var(--text-secondary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .toolbar-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .toolbar-btn.active { background: var(--accent); color: white; }
        .toolbar-btn.filter-active { box-shadow: inset 0 0 0 2px var(--accent); }
        .toolbar-sep { width: 1px; background: var(--border-subtle); margin: 6px 4px; }
        .zoom-display { display: flex; align-items: center; padding: 0 8px; font-size: 12px; font-weight: 500; color: var(--text-secondary); min-width: 52px; justify-content: center; }

        .filter-dropdown, .color-dropdown {
            position: fixed; bottom: 76px; left: 50%; transform: translateX(-50%);
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); padding: 8px;
            display: none; gap: 6px; box-shadow: var(--shadow-md); z-index: 101;
        }
        .filter-dropdown.active, .color-dropdown.active { display: flex; }
        .filter-dropdown .filter-opt, .color-dropdown .color-opt {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent;
        }
        .filter-dropdown .filter-opt:hover, .color-dropdown .color-opt:hover { transform: scale(1.15); }
        .filter-dropdown .filter-opt.selected, .color-dropdown .color-opt.selected { border-color: var(--text-primary); }
        .filter-dropdown .filter-opt.all { background: transparent; position: relative; overflow: hidden; }
        .filter-dropdown .filter-opt.all::before {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(var(--tag-red), var(--tag-orange), var(--tag-yellow), var(--tag-green), var(--tag-blue), var(--tag-purple), var(--tag-pink), var(--tag-red));
        }
        .color-dropdown .color-opt.none { background: var(--bg-card); border: 2px dashed var(--border-active); }

        .conn-direction-picker {
            position: fixed; background: var(--bg-secondary);
            border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
            padding: 4px; display: none; gap: 4px; box-shadow: var(--shadow-lg); z-index: 200;
        }
        .conn-direction-picker.active { display: flex; }
        .conn-direction-picker button {
            width: 32px; height: 32px; border: none; background: var(--bg-card);
            color: var(--text-primary); border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .conn-direction-picker button:hover { background: var(--accent); color: white; }
        .conn-direction-picker button.active { background: var(--accent); color: white; }

        .context-menu {
            position: fixed; background: var(--bg-secondary);
            border: 1px solid var(--border-subtle); border-radius: var(--radius-md);
            padding: 4px; box-shadow: var(--shadow-lg); z-index: 10000; min-width: 160px; display: none;
        }
        .context-menu.active { display: block; }
        .context-menu-item {
            padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer;
            font-size: 13px; color: var(--text-primary);
            display: flex; align-items: center; gap: 8px;
        }
        .context-menu-item:hover { background: var(--bg-hover); }
        .context-menu-item.danger { color: var(--danger); }
        .context-menu-sep { height: 1px; background: var(--border-subtle); margin: 4px 0; }

        .modal {
            position: fixed; inset: 0; background: rgba(9, 9, 11, 0.88);
            display: none; align-items: center; justify-content: center;
            z-index: 9999; backdrop-filter: blur(4px);
        }
        :root.light .modal { background: rgba(0, 0, 0, 0.48); }
        .modal.active { display: flex; }
        .modal-box {
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg); padding: 24px;
            width: 90%; max-width: 400px; box-shadow: var(--shadow-lg);
        }
        .modal-box h3 { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
        .modal-input {
            width: 100%; padding: 12px 14px;
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); color: var(--text-primary);
            font-size: 14px; margin-bottom: 12px;
        }
        .modal-input:focus { outline: none; border-color: var(--accent); }
        .modal-input::placeholder { color: var(--text-placeholder); }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; }
        .modal-btn { padding: 10px 18px; border-radius: var(--radius-sm); border: none; font-size: 13px; font-weight: 500; cursor: pointer; }
        .modal-btn-cancel { background: transparent; color: var(--text-secondary); }
        .modal-btn-cancel:hover { color: var(--text-primary); }
        .modal-btn-submit { background: var(--accent); color: white; }
        .modal-btn-submit:hover { filter: brightness(1.1); }

        .search-bar {
            position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md); padding: 8px 16px;
            display: none; align-items: center; gap: 12px;
            box-shadow: var(--shadow-lg); z-index: 150; min-width: 320px;
        }
        .search-bar.active { display: flex; }
        .search-bar input {
            flex: 1; border: none; background: transparent;
            color: var(--text-primary); font-size: 14px; outline: none;
        }
        .search-bar input::placeholder { color: var(--text-placeholder); }
        .search-nav { display: flex; gap: 4px; align-items: center; }
        .search-nav span { font-size: 12px; color: var(--text-secondary); min-width: 50px; text-align: center; }
        .search-nav button {
            width: 28px; height: 28px; border: none; background: var(--bg-card);
            color: var(--text-secondary); border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .search-nav button:hover { background: var(--bg-hover); color: var(--text-primary); }
        .search-close { width: 28px; height: 28px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .search-close:hover { color: var(--text-primary); }

        .minimap {
            position: fixed; bottom: 80px; right: 16px;
            width: 160px; height: 100px;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); overflow: hidden; z-index: 50;
            cursor: pointer;
        }
        .minimap-content { width: 100%; height: 100%; position: relative; }
        .minimap-viewport { position: absolute; border: 2px solid var(--accent); background: var(--accent-glow); pointer-events: none; border-radius: 2px; }
        .minimap-item { position: absolute; border-radius: 1px; opacity: 0.8; }

        .toast {
            position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            padding: 12px 20px; border-radius: var(--radius-sm);
            font-size: 13px; box-shadow: var(--shadow-md); z-index: 10000;
            opacity: 0; transition: all 0.3s ease; pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: var(--accent); }
        .toast.error { border-color: var(--danger); }

        #fileInput { display: none; }

        .sidebar {
            position: fixed; top: 0; left: 0; width: 240px; height: 100%;
            background: var(--bg-secondary); border-right: 1px solid var(--border-subtle);
            z-index: 200; display: flex; flex-direction: column;
            transform: translateX(-240px); transition: transform var(--transition);
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-toggle {
            position: fixed; top: 16px; left: 16px;
            width: 40px; height: 40px;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); color: var(--text-secondary);
            cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 201;
        }
        .sidebar-toggle:hover { background: var(--bg-hover); color: var(--text-primary); }
        .sidebar.open ~ .sidebar-toggle { left: 256px; }

        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
        .sidebar-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .sidebar-header-actions { display: flex; gap: 8px; align-items: center; }
        .sidebar-pin-btn {
            width: 28px; height: 28px; background: transparent;
            border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
            color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .sidebar-pin-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .sidebar-pin-btn.pinned { background: var(--accent); border-color: var(--accent); color: white; }
        .sidebar-add {
            width: 28px; height: 28px; background: var(--accent);
            border: none; border-radius: var(--radius-sm);
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .sidebar-add:hover { filter: brightness(1.1); }

        .canvas-list { flex: 1; overflow-y: auto; padding: 8px; }
        .canvas-list::-webkit-scrollbar { width: 4px; }
        .canvas-list::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 2px; }

        .canvas-item-entry {
            padding: 10px 12px; border-radius: var(--radius-sm);
            cursor: pointer; display: flex; align-items: center; gap: 10px;
            margin-bottom: 4px; position: relative;
        }
        .canvas-item-entry:hover { background: var(--bg-hover); }
        .canvas-item-entry.active { background: var(--accent-glow); border: 1px solid var(--accent); }
        .canvas-item-entry .canvas-icon {
            width: 32px; height: 32px; background: var(--bg-card);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); flex-shrink: 0; cursor: pointer;
        }
        .canvas-item-entry .canvas-icon:hover { transform: scale(1.1); }
        .canvas-item-entry.active .canvas-icon { background: var(--accent); color: white; }
        .canvas-item-entry .canvas-icon .icon-letter { font-size: 14px; font-weight: 700; text-transform: uppercase; }
        .canvas-item-entry .canvas-info { flex: 1; min-width: 0; }
        .canvas-item-entry .canvas-name { font-size: 13px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .canvas-item-entry .canvas-meta { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .canvas-item-entry .canvas-actions { display: flex; gap: 4px; opacity: 0; }
        .canvas-item-entry:hover .canvas-actions { opacity: 1; }
        .canvas-item-entry .canvas-action-btn {
            width: 24px; height: 24px; background: transparent; border: none;
            border-radius: 4px; color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .canvas-item-entry .canvas-action-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .canvas-item-entry .canvas-action-btn.delete:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .canvas-name-input {
            font-size: 13px; font-weight: 500; color: var(--text-primary);
            background: var(--bg-card); border: 1px solid var(--accent);
            border-radius: 4px; padding: 2px 6px; width: 100%; outline: none;
        }

        .canvas-icon-picker {
            position: absolute; left: 12px; top: 48px;
            background: var(--bg-secondary); border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm); padding: 8px;
            display: none; gap: 6px; flex-wrap: wrap; width: 180px;
            box-shadow: var(--shadow-lg); z-index: 300;
        }
        .canvas-icon-picker.active { display: flex; }
        .canvas-icon-picker .icon-opt {
            width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); background: var(--bg-card); border: 2px solid transparent;
        }
        .canvas-icon-picker .icon-opt:hover { background: var(--bg-hover); color: var(--text-primary); }
        .canvas-icon-picker .icon-opt.selected { border-color: var(--accent); color: var(--accent); }
        .canvas-icon-picker .icon-opt.none { font-size: 14px; font-weight: 700; }

        .help-hint {
            position: fixed; top: 16px; right: 16px;
            padding: 10px 14px; background: var(--bg-secondary);
            border: 1px solid var(--border-subtle); border-radius: var(--radius-sm);
            font-size: 12px; color: var(--text-secondary); z-index: 50;
        }
        .help-hint kbd {
            display: inline-block; padding: 2px 6px;
            background: var(--bg-card); border-radius: 4px; font-size: 11px; margin: 0 1px;
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Canvas</span>
            <div class="sidebar-header-actions">
                <button class="sidebar-pin-btn" id="sidebarPinBtn" title="Pin Sidebar">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 17v5M9 10.76a2 2 0 01-1.11 1.79l-1.78.9A2 2 0 005 15.24V16a1 1 0 001 1h12a1 1 0 001-1v-.76a2 2 0 00-1.11-1.79l-1.78-.9A2 2 0 0115 10.76V5a1 1 0 011-1 1 1 0 001-1V2a1 1 0 00-1-1H8a1 1 0 00-1 1v1a1 1 0 001 1 1 1 0 011 1z"/></svg>
                </button>
                <button class="sidebar-add" id="addCanvasBtn" title="New Canvas">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14" stroke-linecap="round"/></svg>
                </button>
            </div>
        </div>
        <div class="canvas-list" id="canvasList"></div>
        <div class="canvas-icon-picker" id="canvasIconPicker">
            <div class="icon-opt none" data-icon="" title="Text">Aa</div>
            <div class="icon-opt" data-icon="canvas" title="Canvas"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18M3 9h6"/></svg></div>
            <div class="icon-opt" data-icon="music" title="Music"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg></div>
            <div class="icon-opt" data-icon="image" title="Image"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div>
            <div class="icon-opt" data-icon="document" title="Document"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg></div>
            <div class="icon-opt" data-icon="chat" title="Chat"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></div>
            <div class="icon-opt" data-icon="chart" title="Chart"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg></div>
            <div class="icon-opt" data-icon="code" title="Code"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg></div>
            <div class="icon-opt" data-icon="bookmark" title="Bookmark"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg></div>
            <div class="icon-opt" data-icon="star" title="Star"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div>
            <div class="icon-opt" data-icon="heart" title="Heart"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg></div>
            <div class="icon-opt" data-icon="folder" title="Folder"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg></div>
        </div>
    </div>

    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18" stroke-linecap="round"/></svg>
    </button>

    <div id="app" tabindex="0">
        <div id="canvas">
            <div class="grid-overlay"></div>
            <svg id="connectionsSvg"></svg>
        </div>
        <div id="selectionBox"></div>
    </div>

    <div class="search-bar" id="searchBar">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        <input type="text" id="searchInput" placeholder="Search nodes...">
        <div class="search-nav">
            <button id="searchPrev"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg></button>
            <span id="searchCount">0/0</span>
            <button id="searchNext"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></button>
        </div>
        <button class="search-close" id="searchClose"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
    </div>

    <div class="drop-overlay" id="dropZone">
        <div class="drop-content">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 16V4m0 0L8 8m4-4l4 4M3 15v4a2 2 0 002 2h14a2 2 0 002-2v-4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <h3>Drop to add</h3>
            <p>Images, videos, or links</p>
        </div>
    </div>

    <input type="file" id="fileInput" multiple accept="image/*,video/*">

    <div class="toolbar">
        <button class="toolbar-btn" id="addNoteBtn" title="Add Note"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg></button>
        <button class="toolbar-btn" id="addMemoBtn" title="Add Memo"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></button>
        <button class="toolbar-btn" id="addLinkBtn" title="Add Link"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg></button>
        <button class="toolbar-btn" id="addFileBtn" title="Add Image/Video"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" id="colorBtn" title="Set Color"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.3"/><circle cx="12" cy="12" r="5"/></svg></button>
        <button class="toolbar-btn" id="filterBtn" title="Filter by Color"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/></svg></button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" id="undoBtn" title="Undo (Ctrl+Z)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6M3 13c0-4.97 4.03-9 9-9s9 4.03 9 9-4.03 9-9 9a9 9 0 01-7.5-4"/></svg></button>
        <button class="toolbar-btn" id="redoBtn" title="Redo (Ctrl+Y)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6M21 13c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9a9 9 0 007.5-4"/></svg></button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" id="deleteSelectedBtn" title="Delete Selected (Del)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/></svg></button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" id="zoomOutBtn" title="Zoom Out"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M8 11h6"/></svg></button>
        <div class="zoom-display" id="zoomDisplay">100%</div>
        <button class="toolbar-btn" id="zoomInBtn" title="Zoom In"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35M11 8v6M8 11h6"/></svg></button>
        <button class="toolbar-btn" id="fitViewBtn" title="Fit to Screen"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 00-2 2v3M21 8V5a2 2 0 00-2-2h-3M3 16v3a2 2 0 002 2h3M16 21h3a2 2 0 002-2v-3"/></svg></button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" id="exportBtn" title="Export/Import"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></button>
        <div class="toolbar-sep"></div>
        <button class="toolbar-btn" id="themeToggle" title="Theme">
            <svg class="moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
            <svg class="sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        </button>
    </div>

    <div class="color-dropdown" id="colorDropdown">
        <div class="color-opt none" data-color="" title="None"></div>
        <div class="color-opt" data-color="red" style="background:var(--tag-red)" title="Red"></div>
        <div class="color-opt" data-color="orange" style="background:var(--tag-orange)" title="Orange"></div>
        <div class="color-opt" data-color="yellow" style="background:var(--tag-yellow)" title="Yellow"></div>
        <div class="color-opt" data-color="green" style="background:var(--tag-green)" title="Green"></div>
        <div class="color-opt" data-color="blue" style="background:var(--tag-blue)" title="Blue"></div>
        <div class="color-opt" data-color="purple" style="background:var(--tag-purple)" title="Purple"></div>
        <div class="color-opt" data-color="pink" style="background:var(--tag-pink)" title="Pink"></div>
    </div>

    <div class="filter-dropdown" id="filterDropdown">
        <div class="filter-opt all" data-color="all" title="Show All"></div>
        <div class="filter-opt" data-color="red" style="background:var(--tag-red)" title="Red"></div>
        <div class="filter-opt" data-color="orange" style="background:var(--tag-orange)" title="Orange"></div>
        <div class="filter-opt" data-color="yellow" style="background:var(--tag-yellow)" title="Yellow"></div>
        <div class="filter-opt" data-color="green" style="background:var(--tag-green)" title="Green"></div>
        <div class="filter-opt" data-color="blue" style="background:var(--tag-blue)" title="Blue"></div>
        <div class="filter-opt" data-color="purple" style="background:var(--tag-purple)" title="Purple"></div>
        <div class="filter-opt" data-color="pink" style="background:var(--tag-pink)" title="Pink"></div>
    </div>

    <div class="conn-direction-picker" id="connDirectionPicker">
        <button data-dir="none" title="No direction">―</button>
        <button data-dir="forward" title="Forward"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
        <button data-dir="backward" title="Backward"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
        <button data-dir="both" title="Both ways"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 17l-5-5 5-5M17 7l5 5-5 5M2 12h20"/></svg></button>
    </div>

    <div class="child-type-picker" id="childTypePicker">
        <button data-type="note">Note</button>
        <button data-type="memo">Memo</button>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="duplicate"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>Duplicate</div>
        <div class="context-menu-sep"></div>
        <div class="context-menu-item" data-action="lock"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>Lock to Back</div>
        <div class="context-menu-sep"></div>
        <div class="context-menu-item danger" data-action="delete"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/></svg>Delete</div>
    </div>

    <div class="modal" id="linkModal">
        <div class="modal-box">
            <h3>Add Link</h3>
            <input type="text" class="modal-input" id="linkTitle" placeholder="Title (optional)">
            <input type="url" class="modal-input" id="linkUrl" placeholder="https://example.com">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" data-close>Cancel</button>
                <button class="modal-btn modal-btn-submit" id="linkSubmit">Add</button>
            </div>
        </div>
    </div>

    <div class="modal" id="exportModal">
        <div class="modal-box">
            <h3>Export / Import</h3>
            <div class="modal-actions" style="flex-direction:column;gap:12px;margin-top:0">
                <button class="modal-btn modal-btn-submit" id="exportData" style="width:100%">Export Canvas (.json)</button>
                <button class="modal-btn modal-btn-submit" id="importData" style="width:100%;background:var(--bg-card);color:var(--text-primary)">Import Canvas</button>
                <input type="file" id="importInput" accept=".json" style="display:none">
            </div>
            <div class="modal-actions" style="margin-top:16px">
                <button class="modal-btn modal-btn-cancel" data-close>Close</button>
            </div>
        </div>
    </div>

    <div class="help-hint"><kbd>Ctrl+F</kbd> search · <kbd>Ctrl+Z</kbd> undo · <kbd>Del</kbd> delete</div>
    <div class="minimap" id="minimap"><div class="minimap-content" id="minimapContent"></div></div>
    <div class="toast" id="toast"></div>

<script>
(function() {
    const $ = id => document.getElementById(id);
    const canvas = $('canvas'), app = $('app'), dropZone = $('dropZone');
    const contextMenu = $('contextMenu');
    const connectionsSvg = $('connectionsSvg'), minimapContent = $('minimapContent');
    const fileInput = $('fileInput'), toast = $('toast'), zoomDisplay = $('zoomDisplay');
    const filterDropdown = $('filterDropdown'), filterBtn = $('filterBtn');
    const colorDropdown = $('colorDropdown'), colorBtn = $('colorBtn');
    const sidebar = $('sidebar'), sidebarToggle = $('sidebarToggle'), canvasList = $('canvasList');
    const sidebarPinBtn = $('sidebarPinBtn'), canvasIconPicker = $('canvasIconPicker');
    const selectionBox = $('selectionBox');
    const linkModal = $('linkModal'), exportModal = $('exportModal');
    const searchBar = $('searchBar'), searchInput = $('searchInput');
    const connDirectionPicker = $('connDirectionPicker');
    const childTypePicker = $('childTypePicker');
    const minimap = $('minimap');

    const CANVASES_KEY = 'knotpad-canvases', THEME_KEY = 'knotpad-theme';
    const COLORS = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink'];
    const COLOR_MAP = { red: '#ef4444', orange: '#f97316', yellow: '#eab308', green: '#22c55e', blue: '#3b82f6', purple: '#8b5cf6', pink: '#ec4899' };

    const CANVAS_ICONS = {
        canvas: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18M3 9h6"/></svg>',
        music: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',
        image: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>',
        document: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>',
        chat: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',
        chart: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>',
        code: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>',
        bookmark: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"/></svg>',
        star: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
        heart: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>',
        folder: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>'
    };

    // IndexedDB
    let mediaDB = null;
    const DB_NAME = 'knotpad-media', DB_VERSION = 1, MEDIA_STORE = 'media';
    function initMediaDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onerror = () => reject(req.error);
            req.onsuccess = () => { mediaDB = req.result; resolve(); };
            req.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains(MEDIA_STORE)) e.target.result.createObjectStore(MEDIA_STORE, { keyPath: 'id' }); };
        });
    }
    function saveMedia(id, blob) { return new Promise((res, rej) => { if (!mediaDB) { rej(); return; } const tx = mediaDB.transaction(MEDIA_STORE, 'readwrite'); tx.objectStore(MEDIA_STORE).put({ id, blob }); tx.oncomplete = () => res(id); tx.onerror = () => rej(); }); }
    function loadMedia(id) { return new Promise((res) => { if (!mediaDB) { res(null); return; } const tx = mediaDB.transaction(MEDIA_STORE, 'readonly'); const req = tx.objectStore(MEDIA_STORE).get(id); req.onsuccess = () => res(req.result?.blob || null); req.onerror = () => res(null); }); }
    function deleteMedia(id) { if (!mediaDB) return; const tx = mediaDB.transaction(MEDIA_STORE, 'readwrite'); tx.objectStore(MEDIA_STORE).delete(id); }
    const blobURLCache = new Map();

    let scale = 1, offsetX = 0, offsetY = 0;
    let isPanning = false, startX = 0, startY = 0;
    let isSelecting = false, selStartX = 0, selStartY = 0;
    let items = [], connections = [];
    let selectedItems = new Set();
    let selectedConn = null;
    let highestZ = 1, itemId = 0;
    let draggedItem = null, resizingItem = null;
    let connectSource = null, connectHandle = null, tempLine = null;
    let activeFilter = 'all';
    let autoSaveTimer = null;
    let canvases = [], currentCanvasId = null;
    let minimapThrottle = null;
    let sidebarPinned = localStorage.getItem('knotpad-sidebar-pinned') === 'true';
    let iconPickerTarget = null;
    let childPickerData = null;

    // Undo/Redo
    const MAX_HISTORY = 50;
    let undoStack = [], redoStack = [];
    function saveState() {
        const state = {
            items: items.map(i => ({ id: i.id, type: i.type, x: i.x, y: i.y, w: i.w, h: i.h, content: JSON.parse(JSON.stringify(i.content)), color: i.color, locked: i.locked, z: parseInt(i.el.style.zIndex) })),
            connections: connections.map(c => ({ id: c.id, from: c.from.id, fh: c.fh, to: c.to.id, th: c.th, dir: c.dir }))
        };
        undoStack.push(JSON.stringify(state));
        if (undoStack.length > MAX_HISTORY) undoStack.shift();
        redoStack = [];
    }
    function undo() {
        if (undoStack.length < 2) return;
        redoStack.push(undoStack.pop());
        restoreState(JSON.parse(undoStack[undoStack.length - 1]));
        triggerAutoSave();
    }
    function redo() {
        if (!redoStack.length) return;
        const state = redoStack.pop();
        undoStack.push(state);
        restoreState(JSON.parse(state));
        triggerAutoSave();
    }
    function restoreState(state) {
        connections.forEach(c => c.el.remove()); connections = [];
        items.forEach(i => i.el.remove()); items = [];
        selectedItems.clear(); selectedConn = null;
        const map = {};
        state.items.forEach(d => {
            if ((d.type === 'image' || d.type === 'video') && d.content?.startsWith('media_') && !blobURLCache.has(d.content)) return;
            const i = createItem(d, true);
            i.el.style.zIndex = d.z || 1;
            i.locked = d.locked;
            if (i.locked) i.el.classList.add('locked');
            map[d.id] = i;
        });
        state.connections.forEach(d => { if (map[d.from] && map[d.to]) { const c = addConnection(map[d.from], d.fh, map[d.to], d.th, true); c.dir = d.dir || 'none'; updateConnectionArrow(c); } });
        updateMinimap();
    }

    // Search
    let searchResults = [], searchIndex = -1;
    function openSearch() { searchBar.classList.add('active'); searchInput.focus(); }
    function closeSearch() { searchBar.classList.remove('active'); searchInput.value = ''; clearSearchHighlights(); searchResults = []; updateSearchCount(); }
    function clearSearchHighlights() { items.forEach(i => i.el.classList.remove('search-highlight')); }
    function doSearch() {
        const q = searchInput.value.toLowerCase().trim();
        clearSearchHighlights();
        searchResults = [];
        if (!q) { updateSearchCount(); return; }
        items.forEach(item => {
            let text = '';
            if (item.type === 'note') text = (item.content.title + ' ' + item.content.body).toLowerCase();
            else if (item.type === 'memo') text = (item.content || '').toLowerCase();
            else if (item.type === 'link') text = (item.content.title + ' ' + item.content.url).toLowerCase();
            if (text.includes(q)) searchResults.push(item);
        });
        searchIndex = searchResults.length ? 0 : -1;
        updateSearchCount();
        highlightCurrentResult();
    }
    function updateSearchCount() { $('searchCount').textContent = searchResults.length ? `${searchIndex + 1}/${searchResults.length}` : '0/0'; }
    function highlightCurrentResult() {
        clearSearchHighlights();
        if (searchIndex >= 0 && searchResults[searchIndex]) {
            const item = searchResults[searchIndex];
            item.el.classList.add('search-highlight');
            panToItem(item);
        }
    }
    function panToItem(item, animate = true) {
        const targetX = innerWidth / 2 - (item.x + item.w / 2) * scale;
        const targetY = innerHeight / 2 - (item.y + item.h / 2) * scale;
        if (animate) {
            const startX = offsetX, startY = offsetY, startTime = performance.now(), duration = 300;
            function animatePan(now) {
                const t = Math.min((now - startTime) / duration, 1);
                const ease = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
                offsetX = startX + (targetX - startX) * ease;
                offsetY = startY + (targetY - startY) * ease;
                updateTransform();
                if (t < 1) requestAnimationFrame(animatePan);
                else updateMinimap();
            }
            requestAnimationFrame(animatePan);
        } else { offsetX = targetX; offsetY = targetY; updateTransform(); updateMinimap(); }
    }
    searchInput.addEventListener('input', doSearch);
    $('searchPrev').addEventListener('click', () => { if (searchResults.length) { searchIndex = (searchIndex - 1 + searchResults.length) % searchResults.length; updateSearchCount(); highlightCurrentResult(); } });
    $('searchNext').addEventListener('click', () => { if (searchResults.length) { searchIndex = (searchIndex + 1) % searchResults.length; updateSearchCount(); highlightCurrentResult(); } });
    $('searchClose').addEventListener('click', closeSearch);

    function triggerAutoSave() { if (autoSaveTimer) clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(saveCurrentCanvas, 1500); }
    function esc(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }
    function showToast(msg, type = 'success') { toast.textContent = msg; toast.className = 'toast ' + type; requestAnimationFrame(() => toast.classList.add('show')); setTimeout(() => toast.classList.remove('show'), 2000); }
    function generateId() { return 'c' + Date.now() + Math.random().toString(36).substr(2, 5); }

    // Canvas management
    async function loadCanvases() {
        try {
            canvases = JSON.parse(localStorage.getItem(CANVASES_KEY) || '[]');
            if (!canvases.length) canvases = [{ id: generateId(), name: 'Untitled', createdAt: Date.now(), itemCount: 0 }];
            saveCanvasesList();
            const lastId = localStorage.getItem('knotpad-active-canvas');
            const target = canvases.find(c => c.id === lastId) || canvases[0];
            if (target) await switchCanvas(target.id);
            renderCanvasList();
        } catch (e) { console.error(e); }
    }
    function saveCanvasesList() { localStorage.setItem(CANVASES_KEY, JSON.stringify(canvases)); }
    function saveCurrentCanvas() {
        if (!currentCanvasId) return;
        const data = {
            items: items.map(i => ({ id: i.id, type: i.type, x: i.x, y: i.y, w: i.w, h: i.h, content: i.content, color: i.color, locked: i.locked, z: parseInt(i.el.style.zIndex) })),
            connections: connections.map(c => ({ id: c.id, from: c.from.id, fh: c.fh, to: c.to.id, th: c.th, dir: c.dir })),
            view: { scale, offsetX, offsetY }, itemId, highestZ
        };
        try {
            localStorage.setItem('knotpad-data-' + currentCanvasId, JSON.stringify(data));
            const c = canvases.find(x => x.id === currentCanvasId);
            if (c) { c.updatedAt = Date.now(); c.itemCount = items.length; saveCanvasesList(); renderCanvasList(); }
        } catch (e) { showToast('Save failed', 'error'); }
    }
    async function loadCanvasData(id) {
        try {
            const saved = localStorage.getItem('knotpad-data-' + id);
            if (!saved) return;
            const data = JSON.parse(saved);
            itemId = data.itemId || 0; highestZ = data.highestZ || 1;
            if (data.view) { scale = data.view.scale; offsetX = data.view.offsetX; offsetY = data.view.offsetY; updateTransform(); }
            const mediaItems = data.items.filter(d => (d.type === 'image' || d.type === 'video') && d.content?.startsWith('media_'));
            for (const d of mediaItems) { if (!blobURLCache.has(d.content)) { const blob = await loadMedia(d.content); if (blob) blobURLCache.set(d.content, URL.createObjectURL(blob)); } }
            const map = {};
            data.items.forEach(d => { const i = createItem(d, true); i.el.style.zIndex = d.z || 1; i.locked = d.locked; if (i.locked) i.el.classList.add('locked'); map[d.id] = i; });
            data.connections.forEach(d => { if (map[d.from] && map[d.to]) { const c = addConnection(map[d.from], d.fh, map[d.to], d.th, true); c.dir = d.dir || 'none'; updateConnectionArrow(c); } });
            updateMinimap();
            undoStack = [JSON.stringify({ items: data.items, connections: data.connections.map(c => ({...c})) })];
            redoStack = [];
        } catch (e) { console.error(e); }
    }
    async function switchCanvas(id) {
        blobURLCache.forEach(url => URL.revokeObjectURL(url)); blobURLCache.clear();
        connections.forEach(c => { c.el.remove(); if (c.arrow) c.arrow.remove(); }); connections = [];
        items.forEach(i => i.el.remove()); items = [];
        selectedItems.clear(); selectedConn = null;
        itemId = highestZ = 1; scale = 1; offsetX = offsetY = 0;
        updateTransform();
        currentCanvasId = id;
        localStorage.setItem('knotpad-active-canvas', id);
        await loadCanvasData(id);
        setFilter('all');
        updateMinimap();
        renderCanvasList();
    }
    async function createNewCanvas() {
        const nc = { id: generateId(), name: 'Untitled', createdAt: Date.now(), itemCount: 0 };
        canvases.unshift(nc); saveCanvasesList();
        await switchCanvas(nc.id);
    }
    async function deleteCanvas(id) {
        if (canvases.length <= 1) { showToast('Cannot delete last canvas', 'error'); return; }
        if (!confirm('Delete this canvas?')) return;
        const idx = canvases.findIndex(c => c.id === id);
        if (idx > -1) {
            canvases.splice(idx, 1);
            localStorage.removeItem('knotpad-data-' + id);
            saveCanvasesList();
            if (currentCanvasId === id) await switchCanvas(canvases[0].id);
            else renderCanvasList();
            showToast('Canvas deleted');
        }
    }
    function renameCanvas(id, name) { const c = canvases.find(x => x.id === id); if (c) { c.name = name || 'Untitled'; c.updatedAt = Date.now(); saveCanvasesList(); renderCanvasList(); } }
    function getCanvasIconHTML(c) { if (c.icon && CANVAS_ICONS[c.icon]) return CANVAS_ICONS[c.icon]; return `<span class="icon-letter">${esc((c.name || 'U').charAt(0).toUpperCase())}</span>`; }
    function renderCanvasList() {
        canvasList.innerHTML = canvases.map(c => `<div class="canvas-item-entry ${c.id === currentCanvasId ? 'active' : ''}" data-id="${c.id}"><div class="canvas-icon" data-canvas-id="${c.id}">${getCanvasIconHTML(c)}</div><div class="canvas-info"><div class="canvas-name">${esc(c.name)}</div><div class="canvas-meta">${c.itemCount || 0} items</div></div><div class="canvas-actions"><button class="canvas-action-btn rename" title="Rename"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="canvas-action-btn delete" title="Delete"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/></svg></button></div></div>`).join('');
        canvasList.querySelectorAll('.canvas-item-entry').forEach(entry => {
            const id = entry.dataset.id;
            entry.addEventListener('click', async e => { if (!e.target.closest('.canvas-action-btn') && !e.target.closest('.canvas-icon') && id !== currentCanvasId) { saveCurrentCanvas(); await switchCanvas(id); } });
            entry.querySelector('.rename').addEventListener('click', e => { e.stopPropagation(); startRename(entry, id); });
            entry.querySelector('.delete').addEventListener('click', e => { e.stopPropagation(); deleteCanvas(id); });
            entry.querySelector('.canvas-icon').addEventListener('click', e => { e.stopPropagation(); openIconPicker(id, entry); });
        });
    }
    function startRename(entry, id) {
        const nameEl = entry.querySelector('.canvas-name');
        const oldName = canvases.find(c => c.id === id)?.name || '';
        const input = document.createElement('input'); input.type = 'text'; input.className = 'canvas-name-input'; input.value = oldName;
        nameEl.replaceWith(input); input.focus(); input.select();
        const fin = () => renameCanvas(id, input.value.trim() || 'Untitled');
        input.addEventListener('blur', fin);
        input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); } if (e.key === 'Escape') { input.value = oldName; input.blur(); } });
    }
    function openIconPicker(canvasId, entry) {
        iconPickerTarget = canvasId;
        const canvas = canvases.find(c => c.id === canvasId);
        const rect = entry.getBoundingClientRect();
        const sidebarRect = sidebar.getBoundingClientRect();
        canvasIconPicker.style.top = (rect.top - sidebarRect.top) + 'px';
        canvasIconPicker.querySelectorAll('.icon-opt').forEach(opt => opt.classList.toggle('selected', opt.dataset.icon === (canvas?.icon || '')));
        canvasIconPicker.classList.add('active');
    }
    function setCanvasIcon(canvasId, icon) { const c = canvases.find(x => x.id === canvasId); if (c) { c.icon = icon || null; c.updatedAt = Date.now(); saveCanvasesList(); renderCanvasList(); } }
    canvasIconPicker.querySelectorAll('.icon-opt').forEach(opt => { opt.addEventListener('click', e => { e.stopPropagation(); if (iconPickerTarget) setCanvasIcon(iconPickerTarget, opt.dataset.icon); canvasIconPicker.classList.remove('active'); iconPickerTarget = null; }); });

    // Theme
    function loadTheme() { if (localStorage.getItem(THEME_KEY) === 'light') document.documentElement.classList.add('light'); updTheme(); }
    function toggleTheme() { document.documentElement.classList.toggle('light'); localStorage.setItem(THEME_KEY, document.documentElement.classList.contains('light') ? 'light' : 'dark'); updTheme(); }
    function updTheme() { const L = document.documentElement.classList.contains('light'); $('themeToggle').querySelector('.moon').style.display = L ? 'none' : 'block'; $('themeToggle').querySelector('.sun').style.display = L ? 'block' : 'none'; }

    // Viewport
    function updateTransform() { canvas.style.transform = `translate(${offsetX}px,${offsetY}px) scale(${scale})`; zoomDisplay.textContent = Math.round(scale * 100) + '%'; }
    function setZoom(z, cx, cy) {
        cx = cx ?? innerWidth / 2; cy = cy ?? innerHeight / 2;
        z = Math.max(0.1, Math.min(5, z));
        offsetX = cx - (cx - offsetX) * (z / scale);
        offsetY = cy - (cy - offsetY) * (z / scale);
        scale = z; updateTransform(); throttledMinimap();
    }
    function fitToScreen() {
        if (!items.length) { scale = 1; offsetX = offsetY = 0; updateTransform(); return; }
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        items.forEach(i => { minX = Math.min(minX, i.x); minY = Math.min(minY, i.y); maxX = Math.max(maxX, i.x + i.w); maxY = Math.max(maxY, i.y + i.h); });
        const pad = 60, cw = maxX - minX + pad * 2, ch = maxY - minY + pad * 2;
        const newScale = Math.min(Math.min(innerWidth / cw, innerHeight / ch), 2);
        const cx = (minX + maxX) / 2, cy = (minY + maxY) / 2;
        scale = newScale;
        offsetX = innerWidth / 2 - cx * scale;
        offsetY = innerHeight / 2 - cy * scale;
        updateTransform(); updateMinimap();
    }
    function throttledMinimap() { if (minimapThrottle) return; minimapThrottle = requestAnimationFrame(() => { updateMinimap(); minimapThrottle = null; }); }

    // Wheel - zoom canvas or scroll textarea
    app.addEventListener('wheel', e => {
        const t = e.target;
        if (t.classList.contains('note-body') || t.classList.contains('memo-body')) {
            if (t.scrollHeight > t.clientHeight) return;
        }
        e.preventDefault();
        const d = e.deltaY > 0 ? 0.9 : 1.1;
        const rect = app.getBoundingClientRect();
        setZoom(scale * d, e.clientX - rect.left, e.clientY - rect.top);
    }, { passive: false });

    // Mouse handling
    app.addEventListener('mousedown', e => {
        app.focus();
        closeSidebarIfUnpinned();
        if (e.button === 1) { e.preventDefault(); startPan(e.clientX, e.clientY); return; }
        if (e.button === 0 && (e.target === canvas || e.target.classList.contains('grid-overlay') || e.target === app)) {
            if (!e.shiftKey) deselectAll();
            isSelecting = true;
            selStartX = e.clientX; selStartY = e.clientY;
            selectionBox.style.display = 'block';
            selectionBox.style.left = selStartX + 'px'; selectionBox.style.top = selStartY + 'px';
            selectionBox.style.width = '0px'; selectionBox.style.height = '0px';
        }
    });
    function startPan(x, y) { isPanning = true; startX = x - offsetX; startY = y - offsetY; app.classList.add('panning'); }
    function closeSidebarIfUnpinned() { if (!sidebarPinned && sidebar.classList.contains('open')) sidebar.classList.remove('open'); }

    window.addEventListener('mousemove', e => {
        if (isPanning) { offsetX = e.clientX - startX; offsetY = e.clientY - startY; updateTransform(); throttledMinimap(); return; }
        if (isSelecting) {
            const minX = Math.min(selStartX, e.clientX), maxX = Math.max(selStartX, e.clientX);
            const minY = Math.min(selStartY, e.clientY), maxY = Math.max(selStartY, e.clientY);
            selectionBox.style.left = minX + 'px'; selectionBox.style.top = minY + 'px';
            selectionBox.style.width = (maxX - minX) + 'px'; selectionBox.style.height = (maxY - minY) + 'px';
            return;
        }
        if (draggedItem) {
            const rect = app.getBoundingClientRect();
            const curX = (e.clientX - rect.left - offsetX) / scale, curY = (e.clientY - rect.top - offsetY) / scale;
            const newX = curX - draggedItem.ox, newY = curY - draggedItem.oy;
            const dx = newX - draggedItem.x, dy = newY - draggedItem.y;
            selectedItems.forEach(item => { item.x += dx; item.y += dy; item.el.style.left = item.x + 'px'; item.el.style.top = item.y + 'px'; });
            updateAllConnections(); throttledMinimap();
        }
        if (resizingItem) {
            const rect = app.getBoundingClientRect();
            const x = (e.clientX - rect.left - offsetX) / scale, y = (e.clientY - rect.top - offsetY) / scale;
            resizingItem.w = Math.max(140, x - resizingItem.x); resizingItem.h = Math.max(80, y - resizingItem.y);
            resizingItem.el.style.width = resizingItem.w + 'px'; resizingItem.el.style.height = resizingItem.h + 'px';
            updateAllConnections(); throttledMinimap();
        }
        if (tempLine) {
            const rect = app.getBoundingClientRect();
            updateTempLine((e.clientX - rect.left - offsetX) / scale + 10000, (e.clientY - rect.top - offsetY) / scale + 10000);
        }
    });

    window.addEventListener('mouseup', e => {
        if (isPanning) { isPanning = false; app.classList.remove('panning'); }
        if (isSelecting) {
            isSelecting = false;
            const sb = selectionBox.getBoundingClientRect();
            selectionBox.style.display = 'none';
            if (sb.width > 2 && sb.height > 2) {
                const rect = app.getBoundingClientRect();
                const bx = (sb.left - rect.left - offsetX) / scale, by = (sb.top - rect.top - offsetY) / scale;
                const bw = sb.width / scale, bh = sb.height / scale;
                items.forEach(item => { if (item.x < bx + bw && item.x + item.w > bx && item.y < by + bh && item.y + item.h > by) selectItem(item, true); });
            }
        }
        if (draggedItem || resizingItem) {
            if (draggedItem) { selectedItems.forEach(i => i.el.classList.remove('dragging')); canvas.classList.remove('dragging-item'); saveState(); draggedItem = null; }
            if (resizingItem) { saveState(); resizingItem = null; }
            triggerAutoSave();
        }
    });

    // Touch
    let lastDist = 0;
    app.addEventListener('touchstart', e => {
        closeSidebarIfUnpinned();
        if (e.touches.length === 2) lastDist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
        else if (e.touches.length === 1 && (e.target === canvas || e.target === app)) { isPanning = true; startX = e.touches[0].clientX - offsetX; startY = e.touches[0].clientY - offsetY; }
    });
    app.addEventListener('touchmove', e => {
        if (e.touches.length === 2) {
            e.preventDefault();
            const dist = Math.hypot(e.touches[1].clientX - e.touches[0].clientX, e.touches[1].clientY - e.touches[0].clientY);
            const cx = (e.touches[0].clientX + e.touches[1].clientX) / 2, cy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
            const rect = app.getBoundingClientRect();
            setZoom(scale * dist / lastDist, cx - rect.left, cy - rect.top);
            lastDist = dist;
        } else if (isPanning) { offsetX = e.touches[0].clientX - startX; offsetY = e.touches[0].clientY - startY; updateTransform(); throttledMinimap(); }
    }, { passive: false });
    app.addEventListener('touchend', () => isPanning = false);

    // Item creation
    function createItem(cfg, loading = false) {
        const el = document.createElement('div');
        el.className = 'canvas-item' + (loading ? '' : ' new');
        el.style.cssText = `left:${cfg.x}px;top:${cfg.y}px;width:${cfg.w}px;height:${cfg.h}px;z-index:${++highestZ}`;
        let html = '', mediaSrc = '';
        if ((cfg.type === 'image' || cfg.type === 'video') && cfg.content) mediaSrc = cfg.content.startsWith('media_') ? (blobURLCache.get(cfg.content) || '') : cfg.content;
        switch (cfg.type) {
            case 'image': html = `<img class="item-image" src="${mediaSrc}">`; break;
            case 'video': html = `<video class="item-video" src="${mediaSrc}" controls></video>`; break;
            case 'note': html = `<div class="item-note"><input class="note-title" placeholder="Title..." value="${esc(cfg.content.title)}"><textarea class="note-body" placeholder="Write something...">${esc(cfg.content.body)}</textarea></div>`; break;
            case 'memo': html = `<div class="item-memo"><textarea class="memo-body" placeholder="Quick memo...">${esc(cfg.content)}</textarea></div>`; break;
            case 'link': html = `<div class="item-link"><img class="link-favicon" src="https://www.google.com/s2/favicons?domain=${new URL(cfg.content.url).hostname}&sz=64"><div class="link-title">${esc(cfg.content.title)}</div><a class="link-url" href="${cfg.content.url}" target="_blank">${cfg.content.display}</a></div>`; break;
        }
        if (cfg.color) el.style.setProperty('--tag-shadow', `inset 0 4px 0 0 ${COLOR_MAP[cfg.color]}`);
        el.innerHTML = `<div class="item-content">${html}</div><button class="delete-btn">×</button><button class="color-btn"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg></button><div class="color-picker"><div class="color-opt none" data-color="" title="None"></div>${COLORS.map(c => `<div class="color-opt" data-color="${c}" style="background:${COLOR_MAP[c]}" title="${c}"></div>`).join('')}</div><div class="resize-handle"></div><div class="connection-handle top" data-h="top"></div><div class="connection-handle bottom" data-h="bottom"></div><div class="connection-handle left" data-h="left"></div><div class="connection-handle right" data-h="right"></div><button class="add-child-btn top" data-d="top">+</button><button class="add-child-btn bottom" data-d="bottom">+</button><button class="add-child-btn left" data-d="left">+</button><button class="add-child-btn right" data-d="right">+</button>`;
        canvas.appendChild(el);
        const item = { id: cfg.id || `i${++itemId}`, el, type: cfg.type, x: cfg.x, y: cfg.y, w: cfg.w, h: cfg.h, content: cfg.content, color: cfg.color || null, locked: cfg.locked || false };
        items.push(item);
        setupItemEvents(item);
        if (!loading) { throttledMinimap(); if (activeFilter !== 'all' && item.color !== activeFilter) item.el.classList.add('filtered-out'); }
        setTimeout(() => el.classList.remove('new'), 200);
        return item;
    }

    function setItemColor(targetItem, color) {
        const targets = selectedItems.size > 0 ? selectedItems : new Set([targetItem]);
        targets.forEach(item => {
            item.color = color || null;
            if (color) item.el.style.setProperty('--tag-shadow', `inset 0 4px 0 0 ${COLOR_MAP[color]}`);
            else item.el.style.setProperty('--tag-shadow', '0 0 0 0 transparent');
            item.el.querySelectorAll('.color-opt').forEach(o => o.classList.toggle('selected', o.dataset.color === (color || '')));
            if (activeFilter !== 'all') item.el.classList.toggle('filtered-out', item.color !== activeFilter);
        });
        throttledMinimap(); saveState(); triggerAutoSave();
    }

    function setupItemEvents(item) {
        const el = item.el;
        el.addEventListener('mousedown', e => {
            const t = e.target;
            if (t.classList.contains('delete-btn') || t.classList.contains('resize-handle') || t.classList.contains('connection-handle') || t.classList.contains('add-child-btn') || t.classList.contains('color-btn') || t.classList.contains('color-opt') || t.closest('.color-picker') || t.tagName === 'VIDEO' || t.tagName === 'A' || t.tagName === 'INPUT' || t.tagName === 'TEXTAREA') return;
            if (item.locked) return;
            e.stopPropagation();
            if (!selectedItems.has(item) && !e.shiftKey) selectItem(item, false);
            else if (e.shiftKey) { if (selectedItems.has(item)) selectedItems.delete(item); else selectedItems.add(item); item.el.classList.toggle('selected'); }
            else selectItem(item, true);
            el.style.zIndex = ++highestZ;
            const rect = el.getBoundingClientRect();
            item.ox = (e.clientX - rect.left) / scale; item.oy = (e.clientY - rect.top) / scale;
            draggedItem = item;
            selectedItems.forEach(i => i.el.classList.add('dragging'));
            canvas.classList.add('dragging-item');
        });
        el.querySelector('.resize-handle').addEventListener('mousedown', e => { if (item.locked) return; e.stopPropagation(); resizingItem = item; });
        el.querySelector('.delete-btn').addEventListener('click', e => { e.stopPropagation(); if (selectedItems.has(item)) deleteSelectedItems(); else deleteItem(item); });
        const colorBtnEl = el.querySelector('.color-btn'), colorPicker = el.querySelector('.color-picker');
        colorBtnEl.addEventListener('click', e => {
            e.stopPropagation();
            document.querySelectorAll('.color-picker.active').forEach(p => { if (p !== colorPicker) p.classList.remove('active'); });
            colorPicker.classList.toggle('active');
            colorPicker.querySelectorAll('.color-opt').forEach(o => o.classList.toggle('selected', o.dataset.color === (item.color || '')));
        });
        colorPicker.querySelectorAll('.color-opt').forEach(opt => { opt.addEventListener('click', e => { e.stopPropagation(); setItemColor(item, opt.dataset.color || null); colorPicker.classList.remove('active'); }); });
        el.querySelectorAll('.add-child-btn').forEach(btn => { btn.addEventListener('click', e => { e.stopPropagation(); showChildTypePicker(item, btn.dataset.d, e); }); });
        el.querySelectorAll('.connection-handle').forEach(h => {
            h.addEventListener('mousedown', e => { e.stopPropagation(); if (connectSource) completeConnection(item, h.dataset.h); else startConnection(item, h.dataset.h); });
            h.addEventListener('mouseenter', () => { if (connectSource && connectSource !== item) el.classList.add('connect-target'); });
            h.addEventListener('mouseleave', () => el.classList.remove('connect-target'));
        });
        el.addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); if (!selectedItems.has(item)) selectItem(item); showContextMenu(e.clientX, e.clientY, item); });
        if (item.type === 'note') {
            const ti = el.querySelector('.note-title'), tb = el.querySelector('.note-body');
            ti.addEventListener('input', () => { item.content.title = ti.value; autoResizeItem(item); triggerAutoSave(); });
            tb.addEventListener('input', () => { item.content.body = tb.value; autoResizeItem(item); triggerAutoSave(); });
        }
        if (item.type === 'memo') {
            const mb = el.querySelector('.memo-body');
            mb.addEventListener('input', () => { item.content = mb.value; autoResizeItem(item); triggerAutoSave(); });
        }
    }

    function autoResizeItem(item) {
        if (item.type !== 'note' && item.type !== 'memo') return;
        const textarea = item.el.querySelector('.note-body, .memo-body');
        if (!textarea) return;
        textarea.style.height = 'auto';
        const newH = Math.min(Math.max(textarea.scrollHeight + (item.type === 'note' ? 50 : 24), 80), 400);
        if (Math.abs(newH - item.h) > 10) {
            item.h = newH;
            item.el.style.height = item.h + 'px';
            updateAllConnections();
            throttledMinimap();
        }
    }

    function showChildTypePicker(parentItem, direction, e) {
        childPickerData = { parent: parentItem, dir: direction };
        childTypePicker.style.left = e.clientX + 'px'; childTypePicker.style.top = e.clientY + 'px';
        childTypePicker.classList.add('active');
    }
    childTypePicker.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
            if (!childPickerData) return;
            addChildNode(childPickerData.parent, childPickerData.dir, btn.dataset.type);
            childTypePicker.classList.remove('active');
            childPickerData = null;
        });
    });

    function selectItem(item, accumulate = false) { if (!accumulate) deselectAll(); selectedItems.add(item); item.el.classList.add('selected'); window.selectedItem = item; }
    function deselectAll() {
        selectedItems.forEach(i => i.el.classList.remove('selected')); selectedItems.clear(); window.selectedItem = null;
        if (selectedConn) { selectedConn.el.classList.remove('selected'); if (selectedConn.arrow) selectedConn.arrow.classList.remove('selected'); selectedConn = null; }
        hideMenus(); document.querySelectorAll('.color-picker.active').forEach(p => p.classList.remove('active'));
    }
    function deleteSelectedItems() { if (!selectedItems.size) return; saveState(); selectedItems.forEach(item => deleteItem(item, false)); selectedItems.clear(); throttledMinimap(); triggerAutoSave(); }
    function deleteItem(item, update = true) {
        connections.filter(c => c.from === item || c.to === item).forEach(c => deleteConnection(c, false));
        if ((item.type === 'image' || item.type === 'video') && item.content?.startsWith('media_')) { deleteMedia(item.content); const url = blobURLCache.get(item.content); if (url) { URL.revokeObjectURL(url); blobURLCache.delete(item.content); } }
        const i = items.indexOf(item); if (i > -1) { items.splice(i, 1); item.el.remove(); }
        if (update) { saveState(); throttledMinimap(); triggerAutoSave(); }
    }
    function duplicateItem(item) { const pos = findFreePosition(item.x + 24, item.y + 24); createItem({ type: item.type, x: pos.x, y: pos.y, w: item.w, h: item.h, content: JSON.parse(JSON.stringify(item.content)), color: item.color }); saveState(); triggerAutoSave(); }
    function findFreePosition(x, y) { let tries = 0; while (tries < 50 && items.some(i => Math.abs(x - i.x) < 10 && Math.abs(y - i.y) < 10)) { x += 6; y += 6; tries++; } return { x, y }; }

    // Connections
    function startConnection(item, handle) {
        connectSource = item; connectHandle = handle;
        const pos = getHandlePos(item, handle);
        tempLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        tempLine.classList.add('connection-line', 'temp');
        connectionsSvg.appendChild(tempLine);
        updateTempLine(pos.x, pos.y);
    }
    function updateTempLine(ex, ey) { if (!tempLine || !connectSource) return; const sp = getHandlePos(connectSource, connectHandle); tempLine.setAttribute('d', curvePath(sp.x, sp.y, ex, ey)); }
    function completeConnection(target, handle) {
        if (!connectSource || connectSource === target) { cancelConnection(); return; }
        // Remove existing connection between these items if different handles
        const existing = connections.find(c => (c.from === connectSource && c.to === target) || (c.from === target && c.to === connectSource));
        if (existing) deleteConnection(existing, false);
        addConnection(connectSource, connectHandle, target, handle);
        cancelConnection();
        saveState();
    }
    function cancelConnection() { if (tempLine) { tempLine.remove(); tempLine = null; } connectSource = connectHandle = null; items.forEach(i => i.el.classList.remove('connect-target')); }
    function addConnection(from, fh, to, th, loading = false) {
        const conn = { id: `c${Date.now()}`, from, fh, to, th, el: null, arrow: null, dir: 'none' };
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.classList.add('connection-line');
        path.addEventListener('click', e => { e.stopPropagation(); selectConnection(conn, e); });
        connectionsSvg.appendChild(path);
        conn.el = path;
        connections.push(conn);
        updateConnection(conn);
        if (!loading) { throttledMinimap(); triggerAutoSave(); }
        return conn;
    }
    function updateConnection(c) {
        const fp = getHandlePos(c.from, c.fh), tp = getHandlePos(c.to, c.th);
        c.el.setAttribute('d', curvePath(fp.x, fp.y, tp.x, tp.y));
        updateConnectionArrow(c);
    }
    function updateConnectionArrow(c) {
        if (c.arrow) { c.arrow.remove(); c.arrow = null; }
        if (c.dir === 'none') return;
        const fp = getHandlePos(c.from, c.fh), tp = getHandlePos(c.to, c.th);
        const mx = (fp.x + tp.x) / 2, my = (fp.y + tp.y) / 2;
        const angle = Math.atan2(tp.y - fp.y, tp.x - fp.x);
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.classList.add('connection-arrow');
        if (selectedConn === c) g.classList.add('selected');
        const size = 8;
        if (c.dir === 'forward' || c.dir === 'both') {
            const arr = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const x = mx + 10, y = my;
            arr.setAttribute('points', `${x},${y} ${x - size},${y - size / 2} ${x - size},${y + size / 2}`);
            arr.setAttribute('transform', `rotate(${angle * 180 / Math.PI}, ${mx}, ${my})`);
            g.appendChild(arr);
        }
        if (c.dir === 'backward' || c.dir === 'both') {
            const arr = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const x = mx - 10, y = my;
            arr.setAttribute('points', `${x},${y} ${x + size},${y - size / 2} ${x + size},${y + size / 2}`);
            arr.setAttribute('transform', `rotate(${angle * 180 / Math.PI}, ${mx}, ${my})`);
            g.appendChild(arr);
        }
        connectionsSvg.appendChild(g);
        c.arrow = g;
    }
    function updateAllConnections() { connections.forEach(updateConnection); }
    function getHandlePos(item, h) {
        const { x, y, w, h: ih } = item, off = 10000;
        switch (h) { case 'top': return { x: x + w / 2 + off, y: y + off }; case 'bottom': return { x: x + w / 2 + off, y: y + ih + off }; case 'left': return { x: x + off, y: y + ih / 2 + off }; case 'right': return { x: x + w + off, y: y + ih / 2 + off }; }
    }
    function curvePath(x1, y1, x2, y2) { const dx = x2 - x1, dy = y2 - y1, dist = Math.sqrt(dx * dx + dy * dy), curve = Math.min(dist * 0.3, 80); return `M${x1} ${y1} C${x1 + curve * Math.sign(dx || 1)} ${y1}, ${x2 - curve * Math.sign(dx || 1)} ${y2}, ${x2} ${y2}`; }
    function selectConnection(c, e) {
        deselectAll(); selectedConn = c; c.el.classList.add('selected'); if (c.arrow) c.arrow.classList.add('selected');
        showConnDirectionPicker(e.clientX, e.clientY, c);
    }
    function deleteConnection(c, save = true) {
        const i = connections.indexOf(c);
        if (i > -1) { connections.splice(i, 1); c.el.remove(); if (c.arrow) c.arrow.remove(); selectedConn = null; if (save) { saveState(); triggerAutoSave(); } throttledMinimap(); }
    }
    function showConnDirectionPicker(x, y, conn) {
        connDirectionPicker.style.left = x + 'px'; connDirectionPicker.style.top = y + 'px';
        connDirectionPicker.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.dir === conn.dir));
        connDirectionPicker.classList.add('active');
    }
    connDirectionPicker.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', e => {
            e.stopPropagation();
            if (selectedConn) { selectedConn.dir = btn.dataset.dir; updateConnectionArrow(selectedConn); saveState(); triggerAutoSave(); }
            connDirectionPicker.classList.remove('active');
        });
    });
    function addChildNode(parent, dir, type = 'note') {
        const gap = 72, cw = type === 'note' ? 220 : 180, ch = type === 'note' ? 140 : 100;
        let x, y, fh, th;
        switch (dir) {
            case 'top': x = parent.x + parent.w / 2 - cw / 2; y = parent.y - ch - gap; fh = 'top'; th = 'bottom'; break;
            case 'bottom': x = parent.x + parent.w / 2 - cw / 2; y = parent.y + parent.h + gap; fh = 'bottom'; th = 'top'; break;
            case 'left': x = parent.x - cw - gap; y = parent.y + parent.h / 2 - ch / 2; fh = 'left'; th = 'right'; break;
            case 'right': x = parent.x + parent.w + gap; y = parent.y + parent.h / 2 - ch / 2; fh = 'right'; th = 'left'; break;
        }
        const child = type === 'memo' ? addMemo('', x, y, parent.color) : addNote('', '', x, y, parent.color);
        addConnection(parent, fh, child, th);
        saveState();
        return child;
    }

    // Filter
    function setFilter(color) {
        activeFilter = color;
        filterDropdown.querySelectorAll('.filter-opt').forEach(o => o.classList.toggle('selected', o.dataset.color === color));
        filterBtn.classList.toggle('filter-active', color !== 'all');
        items.forEach(item => item.el.classList.toggle('filtered-out', color !== 'all' && item.color !== color));
        throttledMinimap();
    }

    // Context menu
    function showContextMenu(x, y, item) {
        contextMenu.querySelector('[data-action="lock"]').textContent = item.locked ? 'Unlock' : 'Lock to Back';
        contextMenu.style.left = x + 'px'; contextMenu.style.top = y + 'px';
        contextMenu.classList.add('active');
    }
    function hideMenus() { contextMenu.classList.remove('active'); filterDropdown.classList.remove('active'); colorDropdown.classList.remove('active'); connDirectionPicker.classList.remove('active'); childTypePicker.classList.remove('active'); canvasIconPicker.classList.remove('active'); }

    document.addEventListener('click', e => {
        if (!e.target.closest('.color-picker') && !e.target.closest('.color-btn')) document.querySelectorAll('.color-picker.active').forEach(p => p.classList.remove('active'));
        if (!e.target.closest('#filterBtn') && !e.target.closest('#filterDropdown')) filterDropdown.classList.remove('active');
        if (!e.target.closest('#colorBtn') && !e.target.closest('#colorDropdown')) colorDropdown.classList.remove('active');
        if (!e.target.closest('.context-menu')) contextMenu.classList.remove('active');
        if (!e.target.closest('.conn-direction-picker') && !e.target.closest('.connection-line')) connDirectionPicker.classList.remove('active');
        if (!e.target.closest('.child-type-picker') && !e.target.closest('.add-child-btn')) childTypePicker.classList.remove('active');
        if (!e.target.closest('.canvas-icon-picker') && !e.target.closest('.canvas-icon')) { canvasIconPicker.classList.remove('active'); iconPickerTarget = null; }
    });

    contextMenu.querySelectorAll('.context-menu-item').forEach(el => {
        el.addEventListener('click', () => {
            if (window.selectedItem) {
                switch (el.dataset.action) {
                    case 'duplicate': duplicateItem(window.selectedItem); break;
                    case 'lock': window.selectedItem.locked = !window.selectedItem.locked; window.selectedItem.el.classList.toggle('locked', window.selectedItem.locked); if (window.selectedItem.locked) window.selectedItem.el.style.zIndex = 1; saveState(); triggerAutoSave(); break;
                    case 'delete': if (selectedItems.size > 0) deleteSelectedItems(); else deleteItem(window.selectedItem); break;
                }
            }
            hideMenus();
        });
    });

    filterBtn.addEventListener('click', e => { e.stopPropagation(); colorDropdown.classList.remove('active'); filterDropdown.classList.toggle('active'); });
    filterDropdown.querySelectorAll('.filter-opt').forEach(opt => { opt.addEventListener('click', e => { e.stopPropagation(); setFilter(opt.dataset.color); filterDropdown.classList.remove('active'); }); });
    colorBtn.addEventListener('click', e => { e.stopPropagation(); filterDropdown.classList.remove('active'); colorDropdown.classList.toggle('active'); });
    colorDropdown.querySelectorAll('.color-opt').forEach(opt => {
        opt.addEventListener('click', e => {
            e.stopPropagation();
            if (selectedItems.size > 0) { selectedItems.forEach(item => setItemColor(item, opt.dataset.color || null)); }
            colorDropdown.classList.remove('active');
        });
    });

    // Link modal
    function openLinkModal() { linkModal.classList.add('active'); setTimeout(() => $('linkUrl').focus(), 100); }
    function closeLinkModal() { linkModal.classList.remove('active'); $('linkTitle').value = ''; $('linkUrl').value = ''; }
    linkModal.addEventListener('click', e => { if (e.target === linkModal) closeLinkModal(); });
    linkModal.querySelector('[data-close]').addEventListener('click', closeLinkModal);
    $('linkSubmit').addEventListener('click', () => {
        let url = $('linkUrl').value.trim();
        if (url) { if (!url.startsWith('http')) url = 'https://' + url; const x = (innerWidth / 2 - offsetX) / scale - 130, y = (innerHeight / 2 - offsetY) / scale - 50; addLink(url, $('linkTitle').value.trim(), x, y); saveState(); closeLinkModal(); }
    });

    // Export modal
    function openExportModal() { exportModal.classList.add('active'); }
    function closeExportModal() { exportModal.classList.remove('active'); }
    exportModal.addEventListener('click', e => { if (e.target === exportModal) closeExportModal(); });
    exportModal.querySelector('[data-close]').addEventListener('click', closeExportModal);
    $('exportData').addEventListener('click', async () => {
        const data = {
            items: items.map(i => ({ id: i.id, type: i.type, x: i.x, y: i.y, w: i.w, h: i.h, content: i.content, color: i.color, locked: i.locked })),
            connections: connections.map(c => ({ from: c.from.id, fh: c.fh, to: c.to.id, th: c.th, dir: c.dir })),
            name: canvases.find(c => c.id === currentCanvasId)?.name || 'canvas'
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${data.name}.json`; a.click();
        URL.revokeObjectURL(url);
        showToast('Exported');
        closeExportModal();
    });
    $('importData').addEventListener('click', () => $('importInput').click());
    $('importInput').addEventListener('change', async e => {
        const file = e.target.files[0]; if (!file) return;
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            connections.forEach(c => { c.el.remove(); if (c.arrow) c.arrow.remove(); }); connections = [];
            items.forEach(i => i.el.remove()); items = [];
            selectedItems.clear(); itemId = highestZ = 1;
            const map = {};
            data.items.forEach(d => { const i = createItem(d, true); map[d.id] = i; });
            data.connections.forEach(d => { if (map[d.from] && map[d.to]) { const c = addConnection(map[d.from], d.fh, map[d.to], d.th, true); c.dir = d.dir || 'none'; updateConnectionArrow(c); } });
            updateMinimap(); saveState(); triggerAutoSave();
            showToast('Imported');
        } catch (err) { showToast('Import failed', 'error'); }
        e.target.value = '';
        closeExportModal();
    });

    // Keyboard
    document.addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') { e.preventDefault(); openSearch(); return; }
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); return; }
        if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.shiftKey && e.key === 'z'))) { e.preventDefault(); redo(); return; }
        if (e.key === 'Escape') { cancelConnection(); closeLinkModal(); closeExportModal(); closeSearch(); deselectAll(); }
        if ((e.key === 'Delete' || e.key === 'Backspace') && !e.target.matches('input,textarea')) {
            if (selectedItems.size > 0) deleteSelectedItems();
            else if (selectedConn) deleteConnection(selectedConn);
        }
    });

    // Drag & Drop & Paste
    window.addEventListener('dragenter', e => { e.preventDefault(); dropZone.classList.add('active'); });
    window.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('active'); });
    window.addEventListener('dragover', e => e.preventDefault());
    window.addEventListener('drop', e => {
        e.preventDefault(); dropZone.classList.remove('active');
        const rect = app.getBoundingClientRect();
        const x = (e.clientX - rect.left - offsetX) / scale - 100, y = (e.clientY - rect.top - offsetY) / scale - 70;
        if (e.dataTransfer.files.length) [...e.dataTransfer.files].forEach((f, i) => handleFile(f, x + i * 24, y + i * 24));
        else { const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain'); if (url?.startsWith('http')) { addLink(url, '', x, y); saveState(); triggerAutoSave(); } }
    });
    window.addEventListener('paste', e => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        e.preventDefault();
        const cd = e.clipboardData; if (!cd) return;
        const x = (innerWidth / 2 - offsetX) / scale - 100, y = (innerHeight / 2 - offsetY) / scale - 100;
        for (let i = 0; i < cd.items.length; i++) {
            const item = cd.items[i];
            if (item.type.indexOf('image') !== -1) handleFile(item.getAsFile(), x + i * 20, y + i * 20);
            else if (item.kind === 'string' && item.type.indexOf('text/plain') !== -1) {
                item.getAsString(text => { text = text.trim(); if (!text) return; if (/^https?:\/\/[^ "]+$/.test(text)) addLink(text, '', x, y); else addMemo(text, x, y); saveState(); triggerAutoSave(); });
            }
        }
    });

    async function handleFile(file, x, y) {
        const mediaId = 'media_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        if (file.type.startsWith('image/')) {
            const url = URL.createObjectURL(file);
            const img = new Image();
            img.onload = async () => {
                let w = img.width, h = img.height;
                if (w > 400) { h = 400 / w * h; w = 400; } if (h > 300) { w = 300 / h * w; h = 300; }
                URL.revokeObjectURL(url);
                await saveMedia(mediaId, file); blobURLCache.set(mediaId, URL.createObjectURL(file));
                createItem({ type: 'image', x, y, w, h, content: mediaId }); saveState(); triggerAutoSave();
            };
            img.src = url;
        } else if (file.type.startsWith('video/')) {
            await saveMedia(mediaId, file); blobURLCache.set(mediaId, URL.createObjectURL(file));
            createItem({ type: 'video', x, y, w: 400, h: 225, content: mediaId }); saveState(); triggerAutoSave();
        }
    }
    function addLink(url, title, x, y) { const domain = new URL(url).hostname; const item = createItem({ type: 'link', x, y, w: 260, h: 100, content: { url, title: title || domain, display: url.replace(/^https?:\/\//, '').replace(/\/$/, '') } }); triggerAutoSave(); return item; }
    function addNote(title = '', body = '', x, y, color = null) { const pos = findFreePosition(x, y); const item = createItem({ type: 'note', x: pos.x, y: pos.y, w: 220, h: 140, content: { title, body }, color }); triggerAutoSave(); return item; }
    function addMemo(text = '', x, y, color = null) { const pos = findFreePosition(x, y); const item = createItem({ type: 'memo', x: pos.x, y: pos.y, w: 180, h: 100, content: text, color }); triggerAutoSave(); return item; }

    // Toolbar
    $('addNoteBtn').addEventListener('click', () => { const x = (innerWidth / 2 - offsetX) / scale - 110, y = (innerHeight / 2 - offsetY) / scale - 70; addNote('', '', x, y); saveState(); });
    $('addMemoBtn').addEventListener('click', () => { const x = (innerWidth / 2 - offsetX) / scale - 90, y = (innerHeight / 2 - offsetY) / scale - 50; addMemo('', x, y); saveState(); });
    $('addLinkBtn').addEventListener('click', openLinkModal);
    $('addFileBtn').addEventListener('click', () => fileInput.click());
    $('undoBtn').addEventListener('click', undo);
    $('redoBtn').addEventListener('click', redo);
    $('deleteSelectedBtn').addEventListener('click', () => { if (selectedItems.size > 0) { deleteSelectedItems(); showToast('Deleted'); } else if (selectedConn) { deleteConnection(selectedConn); showToast('Connection deleted'); } else { showToast('Nothing selected', 'error'); } });
    $('zoomInBtn').addEventListener('click', () => setZoom(scale * 1.25));
    $('zoomOutBtn').addEventListener('click', () => setZoom(scale / 1.25));
    $('fitViewBtn').addEventListener('click', fitToScreen);
    $('exportBtn').addEventListener('click', openExportModal);
    $('themeToggle').addEventListener('click', toggleTheme);
    fileInput.addEventListener('change', e => { if (e.target.files.length) { const x = (innerWidth / 2 - offsetX) / scale - 100, y = (innerHeight / 2 - offsetY) / scale - 70; [...e.target.files].forEach((f, i) => handleFile(f, x + i * 24, y + i * 24)); fileInput.value = ''; } });

    sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
    if (sidebarPinned) sidebarPinBtn.classList.add('pinned');
    sidebarPinBtn.addEventListener('click', e => { e.stopPropagation(); sidebarPinned = !sidebarPinned; sidebarPinBtn.classList.toggle('pinned', sidebarPinned); localStorage.setItem('knotpad-sidebar-pinned', sidebarPinned); });
    $('addCanvasBtn').addEventListener('click', () => { saveCurrentCanvas(); createNewCanvas(); });

    // Minimap click navigation
    minimap.addEventListener('click', e => {
        if (!items.length) return;
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        items.forEach(i => { minX = Math.min(minX, i.x); minY = Math.min(minY, i.y); maxX = Math.max(maxX, i.x + i.w); maxY = Math.max(maxY, i.y + i.h); });
        minX -= 80; minY -= 80; maxX += 80; maxY += 80;
        const rect = minimap.getBoundingClientRect();
        const sx = (maxX - minX) / 160, sy = (maxY - minY) / 100;
        const clickX = (e.clientX - rect.left) * sx + minX;
        const clickY = (e.clientY - rect.top) * sy + minY;
        const targetX = innerWidth / 2 - clickX * scale, targetY = innerHeight / 2 - clickY * scale;
        const startX = offsetX, startY = offsetY, startTime = performance.now(), duration = 200;
        function animate(now) {
            const t = Math.min((now - startTime) / duration, 1);
            const ease = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
            offsetX = startX + (targetX - startX) * ease;
            offsetY = startY + (targetY - startY) * ease;
            updateTransform();
            if (t < 1) requestAnimationFrame(animate);
            else updateMinimap();
        }
        requestAnimationFrame(animate);
    });

    function updateMinimap() {
        const visible = items.filter(i => !i.el.classList.contains('filtered-out'));
        if (!visible.length) { minimapContent.innerHTML = '<div class="minimap-viewport"></div>'; return; }
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        visible.forEach(i => { minX = Math.min(minX, i.x); minY = Math.min(minY, i.y); maxX = Math.max(maxX, i.x + i.w); maxY = Math.max(maxY, i.y + i.h); });
        minX -= 80; minY -= 80; maxX += 80; maxY += 80;
        const s = Math.min(160 / (maxX - minX), 100 / (maxY - minY));
        let html = '<svg style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none">';
        connections.forEach(c => {
            if (c.from.el.classList.contains('filtered-out') || c.to.el.classList.contains('filtered-out')) return;
            const fx = (c.from.x + c.from.w / 2 - minX) * s, fy = (c.from.y + c.from.h / 2 - minY) * s;
            const tx = (c.to.x + c.to.w / 2 - minX) * s, ty = (c.to.y + c.to.h / 2 - minY) * s;
            html += `<line x1="${fx}" y1="${fy}" x2="${tx}" y2="${ty}" stroke="var(--accent-dim)" stroke-width="1"/>`;
        });
        html += '</svg>';
        visible.forEach(i => { const bg = i.color ? COLOR_MAP[i.color] : 'var(--text-secondary)'; html += `<div class="minimap-item" style="left:${(i.x - minX) * s}px;top:${(i.y - minY) * s}px;width:${Math.max(3, i.w * s)}px;height:${Math.max(2, i.h * s)}px;background:${bg}"></div>`; });
        const vx = (-offsetX / scale - minX) * s, vy = (-offsetY / scale - minY) * s;
        html += `<div class="minimap-viewport" style="left:${vx}px;top:${vy}px;width:${innerWidth / scale * s}px;height:${innerHeight / scale * s}px"></div>`;
        minimapContent.innerHTML = html;
    }

    // Init
    loadTheme();
    updateTransform();
    initMediaDB().then(() => loadCanvases()).catch(e => { console.error(e); loadCanvases(); });

    // Register Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW registered'))
            .catch(err => console.log('SW registration failed:', err));
    }
})();
</script>
</body>
</html>
